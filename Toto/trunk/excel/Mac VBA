' at top

Private Declare Function popen Lib "libc.dylib" (ByVal command As String, ByVal mode As String) As Long
Private Declare Function pclose Lib "libc.dylib" (ByVal file As Long) As Long
Private Declare Function fread Lib "libc.dylib" (ByVal outStr As String, ByVal size As Long, ByVal items As Long, ByVal stream As Long) As Long
Private Declare Function feof Lib "libc.dylib" (ByVal file As Long) As Long

' functions

Function AzquoPost1(strURL, ByVal strPostData As String)
    If strURL = "Name" Then
       strPostData = "json={""connectionId"":""" & azConnectionId & """," & strPostData & "}"
    Else
       strPostData = "connectionid=" & azConnectionId & "&" & strPostData
    End If
  '  Dim pXmlHttp As Object
   ' Set pXmlHttp = CreateObject("MSXML2.XMLHTTP")
    '  pXmlHttp.Open "POST", "http://bomorgan.co.uk:8080/api/" & strURL, False
  '  pXmlHttp.Open "POST", "http://192.168.1.1:8080/api/" & strURL, False
'    pXmlHttp.Open "POST", "http://localhost:8080/api/" & strURL, False
   ' pXmlHttp.setRequestHeader "Content-Type", "application/x-www-form-urlencoded"
    'pXmlHttp.send (strPostData)


     AzquoPost1 = HTTPPost("http://192.168.1.1:8080/api/" & strURL, strPostData)

     If Left(AzquoPost1, 6) = "error:" Then
        MsgBox (AzquoPost1)
        End
     End If

End Function


Function execShell(command As String, Optional ByRef exitCode As Long) As String
    Dim file As Long
    file = popen(command, "r")

    If file = 0 Then
        Exit Function
    End If

    While feof(file) = 0
        Dim chunk As String
        Dim read As Long
        chunk = Space(50)
        read = fread(chunk, 1, Len(chunk) - 1, file)
        If read > 0 Then
            chunk = Left$(chunk, read)
            execShell = execShell & chunk
        End If
    Wend

    exitCode = pclose(file)
End Function

Function HTTPPost(sUrl As String, sQuery As String) As String

    Dim sCmd As String
    Dim sResult As String
    Dim lExitCode As Long

    sCmd = "curl --data """ & sQuery & """" & " " & sUrl
    sResult = execShell(sCmd, lExitCode)
MsgBox (sCmd & " - " & sResult)
    ' ToDo check lExitCode

    HTTPPost = sResult

End Function